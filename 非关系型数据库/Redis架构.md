# Redis架构模式

## 单机模式
单个服务器安装redis，所有的请求都由单机进行处理。单机redis能够承受几万左右QPS（每秒查询数），但如果QPS过高，单机redis就挂掉了。

问题：单机无法处理高并发，且没有故障处理机制。

## 主从模式
Redis复制(Replication)功能允许用户根据一个Redis服务器来创建任意多个复制节点，被复制的服务器是Master节点，复制出的服务器是Slave节点。

Slave节点只支持读操作，不支持写操作，Master节点通过网络IO将写入数据同步给Slave节点，来保证数据一致性。如果Master节点宕机，那么从Slave节点选出一个新的Master节点。

    主从模式优点：
    (1).降低了主服务器读操作压力，并没减轻主服务器的写操作压力。
    (2).拓展性强，QPS增加，可以增加Slave节点。
    (3).主节点宕机，从节点可以继续顶替主节点进行服务。
    缺点：
    (1).没有解决主节点写操作压力，整个系统的写能力、存储能力依旧受单机性能限制；
    (2).数据冗余（每个节点的数据一致）；
    (3).主从转换的过程需要人工干预（修改应用主节点地址，还要命令所有从节点去复制新的主节点）。
    (4).在线扩容很困难

## 哨兵模式
哨兵(Sentinel)模式在主从模式的基础上，增加了自动化故障恢复功能，来解决需要人工干预问题。

哨兵模式由两类节点组成：哨兵节点和数据节点。哨兵节点不存储数据，用来监控Redis主从服务器，并且提供主服务器宕机自动故障转移功能。主要实现以下三个功能：
* 监控：哨兵不断检查(心跳)主服务器和从服务器是否正常运作；
* 提醒：当某个数据节点出现问题时，哨兵向管理员或其他应用程序发送通知；
* 自动故障迁移：当主服务器故障时，哨兵自动主从转换。


哨兵工作原理：
定时任务：
* 每 1 秒每个 Sentinel 对其他 Sentinel 和 Redis 节点执行 PING 操作，这是一个心跳检测，是判定节点状态的依据。
* 每 2 秒每个 Sentinel 通过 Master 节点的 channel 交换信息（Publish/Subscribe）；
* 每 10 秒每个 Sentinel 会对 Master 和 Slave 执行 INFO 命令，这个任务主要达到两个目的：
    * 发现 Slave 节点；
    * 确认主从关系。

主观下线和客观下线：
* 主观下线(SDOWN)：单个哨兵实例对服务器做出下线判断（在给定阈值内没有收到PING回复或受到错误信息），哨兵会标记服务器为SDOWN。
* 客观下线：多个哨兵实例对同一个服务器进行判断，如果判断主观下线的哨兵数量超过阈值，那么服务器被标记为ODOWN。只有当Master被标记为ODOWN时，才会进行故障迁移。

仲裁：是客观下线的实现机制。可以在配置文件中设置quorum实现。当一个哨兵实例将Master标记为SDOWN后，会将这个判定通过 `sentinel is-master-down-by-addr` 来询问其他哨兵实例，最终达成SDOWN的哨兵个数达到quorum时，该Master就会被认定为客观下线，并故障转移。

整体流程：
1. 哨兵节点以每秒一次的频率向其他哨兵节点和数据节点发送PING
2. 如果某个实例回复PING命令时间超出阈值(own-after-milliseconds)，就会被标记为主动下线。
3. 当一个Master被标记为主动下线，正在监视这个 Master 的所有 Sentinel 要以每秒一次的频率确认 Master 是否真的进入主观下线状态；当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认 Master 的确进入了主观下线状态，则 Master 会被标记为客观下线；
4. 如果 Master 处于 ODOWN 状态，则投票自动选出新的主节点。将剩余的从节点指向新的主节点继续进行数据复制；
5. 在正常情况下，每个 Sentinel 会以每 10 秒一次的频率向它已知的所有 Master，Slave 发送 INFO 命令；当 Master 被 Sentinel 标记为客观下线时，Sentinel 向已下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次；
6. 若没有足够数量的 Sentinel 同意 Master 已经下线，Master 的客观下线状态就会被移除。若 Master 重新向 Sentinel 的 PING 命令返回有效回复，Master 的主观下线状态就会被移除。

    优点：解决了主从模式的人工干预问题，系统更加健壮，可用性更强
    缺点: 没有解决主从模式仍然受限于单机性能的缺点。动态扩容复杂。
    


## 集群模式
哨兵模式解决了自动故障迁移问题，但是每个数据节点存储的数据仍然是一致的， 也就是说存储的数据量、写操作能力仍然受限于单机性能。

Redis提出了集群模式，实现了Redis的分布式存储（数据分片）